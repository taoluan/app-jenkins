pipeline {
    agent any
    
    stages {
        stage('SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                script {
                    def mvn = tool 'Maven 3.6'
                    withSonarQubeEnv {
                        sh "${mvn}/bin/mvn clean verify sonar:sonar -Dsonar.projectKey=jenkins -Dsonar.projectName='jenkins' -Dsonar.sources=backend,frontend -Dsonar.exclusions='**/vendor/**' -Dsonar.exclusions='**/node_modules/**'"
                    }
                }
            }
        }

        stage("Quality Gate") {
          steps {
            timeout(time: 2, unit: 'MINUTES') {
              waitForQualityGate abortPipeline: true
            }
          }
        }
    }

    post { 
      always { 
          cleanWs()
      }
    }
}
